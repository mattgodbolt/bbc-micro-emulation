<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Emulating a BBC Micro in Javascript">
    <meta name="author" content="Matt Godbolt">

    <title>Emulating a BBC Micro in Javascript</title>

    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <link rel="stylesheet" href="reveal.js/css/theme/night.css" id="theme">
    <link rel="stylesheet" href="lib/css/fullscreen-img.css">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
        //        if (window.location.search.match(/print-pdf/gi)) {
        //            document.getElementById("theme").remove();
        //        }
    </script>
    <style>
        @font-face {
            font-family: 'Teletext';
            src: url('teletext.ttf');
        }

        .no-border {
            border: none !important;
            box-shadow: none !important;
        }

        .stis {
            background: transparent !important;
        }

        div.footer {
            position: absolute;
            height: 15%;
            width: 100%;
            bottom: 0;
            background: #008dd4;
            border-top: 1px solid #0800d4;
        }

        span.cursor::before {
            content: "\2588";
        }

        span.cursor.blink {
            opacity: 0;
        }

        .hidden {
            display: none !important;
        }

        div.flex {
            display: flex;
            justify-content: space-around;
        }

        .w40 {
            width: 40%;
        }

        div.footer img {
            margin-top: 30px;
        }

        img.au-mag {
            height: 550px;
        }

        .reveal {
            font-size: 30px;
        }

        .reveal h1,
        .reveal h2,
        .reveal h3,
        .reveal h4,
        .reveal h5,
        .reveal h6 {
            font-family: "Teletext", Impact, sans-serif;
        }

        .reveal .teletext {
            font-family: "Teletext", Impact, sans-serif;
        }

        .reveal .slides section .fragment.highlight-current-code {
            opacity: 1;
            visibility: inherit;
        }

        .reveal .slides section .fragment.highlight-current-code.current-fragment {
            background: #555a5f;
            color: #ffffff;
        }

        .registers code {
            text-decoration: underline;
        }

        div.computers img {
            height: 150px;
        }

        div.computers img.big {
            height: 300px;
        }

        table.rol {
            font-size: smaller;
        }

        table.horizontal {
            border-collapse: collapse;
        }

        table.horizontal th,
        table.horizontal td {
            border: 1px solid grey;
            text-align: center;
            width: 6em;
        }

        table.horizontal th:nth-child(even) {
            background-color: #444;
        }

        table.horizontal th:nth-child(odd) {
            background-color: #222;
        }

        table.horizontal td:nth-child(even) {
            background-color: #444;
        }

        table.horizontal td:nth-child(odd) {
            background-color: #222;
        }

        table.opcodes th {
            font-family: monospace;
        }

        div.credit {
            font-size: small;
        }

        div.wavedrom {
            background: #ffffff;
        }

        table.memmap {
            width: 50%;
            font-size: 0.6em;
        }

        table.memmap th {
            width: 6em;
            font-family: monospace;
            font-weight: normal;
            text-align: center;
        }

        table.memmap .addr {
            font-family: monospace;
        }

        table.memmap td {
            vertical-align: middle;
        }

        table.memmap tr.osrom {
            background-color: #222244;
        }

        table.memmap tr.hw {
            background-color: #444433;
        }

        table.memmap tr.rom1 {
            background-color: #222233;
        }

        table.memmap tr.ram1 {
            background-color: #223322;
        }

        table.memmap tr.ram2 {
            background-color: #283828;
        }

        code.asm6502,
        code.javascript {
            font-size: 22pt;
            line-height: 110%;
        }

        .non-retro h1,
        .non-retro h2,
        .non-retro h3,
        .non-retro h4 {
            font-family: "Helvetica", sans-serif;
        }

        .non-retro h1 {
            font-size: 4em;
            font-weight: bold;
        }

        .non-retro h2 {
            font-size: 2.5em;
            font-weight: bold;
        }

        .non-retro h3 {
            font-size: 2em;
            font-style: italic;
        }
    </style>
    <script src="default.js" type="text/javascript"></script>
</head>

<body>

    <div class="reveal">

        <section class="slides">
            <!---------------------------------------------------------------------->
            <section>
                <section class="non-retro">
                    <h1>A Beeb in your browser</h1>
                    <h3><a href="https://twitter.com/mattgodbolt/">Matt Godbolt</a></h3>
                    <h3>ABUG 6<sup>th</sup> June 2020 </h3>
                </section>
                <section>
                    <h2 class="type-in"><span>A Beeb in your browser</span></h2>
                    <h4 class="type-in"><span>Matt Godbolt</span></h4>
                    <h4 class="type-in"><span>Trying to recapture a lost youth</span></h4>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>Who am I?</h2>
                    <img class="fragment no-border" src="ce.svg" height="400px">
                </section>
                <section>
                    <h2>Why the Beeb?</h2>
                    <img class="fragment au-mag" src="AcornUser1.png">
                </section>
                <section>
                    <h2>Why the Beeb?</h2>
                    <img src="AcornUser2.png" class="au-mag">
                </section>
                <section>
                    <h2>Why a Browser?</h2>
                    <img class="no-border fragment" src="Exile.png">
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>jsbeeb</h2>
                    <ul>
                        <li>Live at <a href="https://bbc.xania.org" target="_blank">bbc.xania.org</a></li>
                        <li>Powers <a href="https://www.bbcmicro.co.uk">bbcmicro.co.uk</a></li>
                    </ul>
                </section>
                <section>
                    <h2>Features</h2>
                    <ul>
                        <li>Fullscreen</li>
                        <li>Printer</li>
                        <li>Freeze / Speedy</li>
                        <li>Debugger</li>
                    </ul>
                </section>
                <section>
                    <h2>Debugging</h2>
                    <ul>
                        <li>Registers</li>
                        <li>Breakpoints</li>
                        <li>Watchpoints</li>
                        <li>Traces</li>
                    </ul>
                </section>
                <section>
                    <h2>Debugging</h2>
                    <ul>
                        <li>j/k; u/i; U/I</li>
                        <li>n/m/o</li>
                        <li>t - breakpoint</li>
                    </ul>
                </section>
                <section>
                    <h2>URLs</h2>
                    <ul>
                        <li>Loading <code>?disc=XX</code></li>
                        <li>Loading BASIC <code>?loadBasic=XX</code></li>
                        <li>Booting <code>?autoboot</code></li>
                        <li><code>?noseek</code></li>
                        <li><a href="http://bbc.xania.org/?patch=@31ac,0769:6e6c6d68667a">Patching</a> (<a
                                href="https://xania.org/201406/elites-crazy-string-format">blog</a>)</li>
                        <li><a href="https://github.com/mattgodbolt/jsbeeb#url-parameters">Many more</a></li>
                    </ul>
                </section>
                <section>
                    <h2>Just in!</h2>
                    <a href="https://github.com/mattgodbolt/jsbeeb/releases/tag/v0.0.6" target="_blank">"Native"
                        jsbeeb</a>
                </section>
            </section>


            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>Emulating!</h2>
                    <img class="stretch" src="MOS_6502_layers_top.png">
                    <aside class="notes">8-bit microprocessor; 3510 transistors, laid out by hand. First produced in
                        1975.
                        Over 10 billion made so far
                    </aside>
                </section>
                <section>
                    <h2>Instructions</h2>
                    <pre><code class="asm6502" data-trim>
LDA STA LDX ... ; load / store A, X, Y
TAX TXA ...     ; transfer A to X
PHA PLA         ; push A / pull A
CMP             ; compare with A
ADC SBC         ; add / subtract with carry
CLC SEC         ; clear / set carry
JMP             ; jump
BEQ BNE BCS BCC ; branch ==, !=, carry set/clear
BMI BPL ...     ; &lt;0, &gt;=0
JSR             ; jump to subroutine
RTS             ; return from subroutine
                     </code></pre>
                </section>
                <section>
                    <h2>Addressing modes</h2>
                    <pre><code class="asm6502" data-trim>
a9 20     LDA #$20     ; A = 0x20

a5 70     LDA $70      ; A = readmem(0x70)

ad 34 12  LDA $1234    ; A = readmem(0x1234)
                     </code></pre>
                </section>
                <section>
                    <h2>Addressing modes</h2>
                    <pre><code class="asm6502" data-trim>
bd 34 12  LDA $1234, X ; A = readmem(0x1234 + X)
b9 34 12  LDA $1234, Y ; A = readmem(0x1234 + Y)

b1 70     LDA ($70), Y ; t1 = readmem(0x70)
                       ; t2 = readmem(0x71)
                       ; addr = t1 | (t2&lt;&lt;8)
                       ; A = readmem(addr + Y)

b5 70     LDA $70, X   ; A = readmem(0x70 + X)
                     </code></pre>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>Emulating a 6502</h2>
                    <ul class="fragment">
                        <li>Fetch next instruction</li>
                        <li>Decode it</li>
                        <li>Execute it</li>
                    </ul>
                </section>
                <section>
                    <h2>Emulation</h2>
                    <pre><code class="javascript" data-trim data-noescape>
<span class="fragment highlight-current-code">var a = 0, x = 0, y = 0, pc = readword(0xfffe);
</span>while (true) {
  switch (<span class="fragment highlight-current-code">readmem(pc++)</span>) {
<div class="fragment highlight-current-code">  case 0xa9: // LDA #imm
    a = readmem(pc++); break;
</div><div class="fragment highlight-current-code">  case 0xad: // LDA $addr
    var addr = readword(pc); pc += 2;
    a = readmem(addr);
    break;
</div>  // and so on for all other instructions...
  }
}
</code></pre>
                </section>
                <section>
                    <h2>Except...</h2>
                    <ul>
                        <li>Setting flags</li>
                        <li>Memory access</li>
                        <li>Hardware</li>
                        <li>Interrupts</li>
                        <li>Handling time</li>
                    </ul>
                </section>
                <section>
                    <h2>Processor status: Flags</h2>
                    <table class="horizontal">
                        <thead>
                            <tr>
                                <th>7</th>
                                <th>6</th>
                                <th>5</th>
                                <th>4</th>
                                <th>3</th>
                                <th>2</th>
                                <th>1</th>
                                <th>0</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Negative</td>
                                <td>oVerflow</td>
                                <td>-</td>
                                <td>-</td>
                                <td>Decimal</td>
                                <td>Interrupt<br>disable</td>
                                <td>Zero</td>
                                <td>Carry
                            </tr>
                        </tbody>
                    </table>
                    <br>
                    <ul class="fragment">
                        <li>Z &amp; N set on ALU/load instruction</li>
                        <li>C set by shifts &amp; arithmetic</li>
                        <li>V set by arithmetic</li>
                        <li>D, V, C and I controlled by special instructions</li>
                    </ul>
                </section>
                <section>
                    <h2>So now we have:</h2>
                    <pre><code class="javascript" data-trim>
case 0xa9: // LDA #imm
  a = readmem(pc++);
  p.z = !a;
  p.n = !!(a &amp; 0x80);
  break;             </code></pre>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>Memory</h2>
                    <table class="fragment memmap">
                        <tbody>
                            <tr>
                                <th>0x10000</th>
                            </tr>
                            <tr class="osrom">
                                <th>&uarr;<br>0xff00</th>
                                <td>256 bytes OS ROM</td>
                            </tr>
                            <tr class="hw">
                                <th>&uarr;<br>0xfe00</th>
                                <td>256 bytes hardware</td>
                            </tr>
                            <tr class="osrom">
                                <th>&uarr;<br>0xfd00</th>
                                <td>256 bytes ROM</td>
                            </tr>
                            <tr class="hw">
                                <th>&uarr;<br>0xfc00</th>
                                <td>256 bytes hardware</td>
                            </tr>
                            <tr class="osrom">
                                <th>&uarr;<br>&uarr;<br>0xc000</th>
                                <td>15.5KB OS ROM</td>
                            </tr>
                            <tr class="rom1">
                                <th>&uarr;<br>&uarr;<br>0x8000</th>
                                <td>16KB Paged ROM</td>
                            </tr>
                            <tr class="ram2">
                                <th>&uarr;<br>&uarr;<br>0x4000</th>
                                <td>16KB RAM</td>
                            </tr>
                            <tr class="ram1">
                                <th>&uarr;<br>&uarr;<br>0x0000</th>
                                <td>16KB RAM</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
                <section>
                    <pre><code class="javascript" data-trim>
var ram = new Uint8Array(0x8000), romsel = 0, roms = [];
var os = load("OS");
roms[15] = load("BASIC");

function readmem(addr) {
  if (addr &lt; 0x8000) return ram[addr];
  if (addr &lt; 0xc000) return roms[romsel][addr - 0x8000];
  if ((addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00)
      || (addr &gt;= 0xfc00 &amp;&amp; addr &lt; 0xfd00))
    return readhw(addr);
  return os[addr - 0xc000];
}
                         </code></pre>
                </section>
                <section>
                    <pre><code class="javascript" data-trim>
function writemem(addr, b) {
    if (addr &lt; 0x8000) ram[addr] = b;
    if (addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00) writehw(addr, b);
    // else does nothing - it's ROM
}
                         </code></pre>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>The outside world</h2>
                    <ul>
                        <li class="fragment">Video chips (6845, Video ULA, SAA5050)</li>
                        <li class="fragment">Sound (SN76489)</li>
                        <li class="fragment">Timers (6522 VIA)</li>
                    </ul>
                </section>
                <section>
                    <h2>Putting it together</h2>
                    <ul>
                        <li>Run CPU for 1/60th second</li>
                        <li>Paint the screen!</li>
                        <li><a href="https://bbc.xania.org/?videoCyclesBatch=8000&keyLayout=physical&autoboot&noseek"
                                target="_blank">Demo</a> </li>
                    </ul>
                </section>
                <section>
                    <h2>What happened?</h2>
                    <img src="BrokenElite.png" class="stretch">
                </section>
                <section>
                    <h2>Fixing it</h2>
                    <pre><code class="javascript" data-trim data-noescape>
case 0xa9: // LDA #imm
<div class="fragment highlight-current-code">  a = readmem(pc++);
</div>  p.z = !!a;
  p.n = !!(a &amp; 0x80);
<div class="fragment highlight-current-code">  video.run(2);
</div><div class="fragment highlight-current-code">  timers.run(2);
</div>  break;
                     </code></pre>

                    <h3 class="fragment"><a href="https://bbc.xania.org/?disc=elite.ssd&autoboot&keyLayout=physical&noseek"
                            target="_blank">Demo</a>
                    </h3>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>More games</h2>
                    <img src="Zalaga.png" class="stretch">
                    <h3>
                        <a href="https://bbc.xania.org/?disc=Zalaga.ssd&autoboot&keyLayout=gaming&model=Master&noseek"
                            target="_blank">Zalaga</a></h3>
                    <aside class="notes">Fun part of emulation! e.g. address $1114. SAX zp instruction. show debugger
                    </aside>
                </section>
                <section>
                    <h2>Inside the 6502</h2>
                    <ul>
                        <table class="opcodes">
                            <tr>
                                <th>$84 100001<span class="fragment highlight-current-red"
                                        data-fragment-index=1>00</span>
                                </th>
                                <td>STY zp</td>
                            </tr>
                            <tr>
                                <th>$85 100001<span class="fragment highlight-current-red"
                                        data-fragment-index=1>01</span>
                                </th>
                                <td>STA zp</td>
                            </tr>
                            <tr>
                                <th>$86 100001<span class="fragment highlight-current-red"
                                        data-fragment-index=1>10</span>
                                </th>
                                <td>STX zp</td>
                            </tr>
                            <tr>
                                <th>$87 100001<span class="fragment highlight-current-red"
                                        data-fragment-index=1>11</span>
                                </th>
                                <td>???</td>
                            </tr>
                        </table>
                    </ul>
                </section>
                <section>
                    <h2>Real decoding</h2>
                    <img src="6502_pad_annot_07.png" class="stretch">
                    <div class="credit">&copy;2010 Visual6502.org, used with permission</div>
                    <aside class="notes">
                        Thanks to Visual 6502 people!<br>
                        PLA is a 130x21 ROM, indexed by 8 instr bits + ~bits (minus one), and 6 bits of T-state..
                        output is 130 bits that enable various parts of the chip.
                        SAX enables both "A" and "X" parts
                        NMOS transistors drain? something?
                    </aside>
                </section>
                <section>
                    <h2>Inside the 6502</h2>
                    <pre style="width:40%">
                 <span class="fragment highlight-current-red" data-fragment-index="2">+-----+</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">-----</span><span
                         class="fragment highlight-current-red" data-fragment-index="1">+-----+</span>
                 <span class="fragment highlight-current-red" data-fragment-index="2">|  A  |</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">  X  </span><span
                         class="fragment highlight-current-red" data-fragment-index="1">|  Y  |</span>
                 <span class="fragment highlight-current-red" data-fragment-index="2">+-----+</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">-----</span><span
                         class="fragment highlight-current-red" data-fragment-index="1">+-----+</span>
                    <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
        /+--------- <span class="fragment highlight-current-red" data-fragment-index="2">|</span> --- <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span> <span
                         class="fragment highlight-current-red" data-fragment-index="1">(!s && !t)</span>
        ||          <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
+----------+        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
| opcode|| |        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
| 100001<span class="fragment highlight-current-red" data-fragment-index="3">s</span><span
                         class="fragment highlight-current-red" data-fragment-index="2">t</span> |<span
                         class="fragment highlight-current-red"
                         data-fragment-index="2">------->t</span>     <span class="fragment highlight-current-red"
                                                                            data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
+----------+        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
     ^  <span class="fragment highlight-current-red" data-fragment-index="3">\----------</span> <span
                         class="fragment highlight-current-red" data-fragment-index="2">|</span> <span
                         class="fragment highlight-current-red" data-fragment-index="3">--->s</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
     |              <span class="fragment highlight-current-red" data-fragment-index="2">\</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">/</span>
     |               <span class="fragment highlight-current-red" data-fragment-index="2">\</span>    <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>    <span
                         class="fragment highlight-current-red" data-fragment-index="1">/</span>
  select              write bus
   store
            </pre>
                </section>
                <section>
                    <h2>Inside the 6502</h2>
                    <pre style="width:40%">
                 <span class="fragment highlight-current-red" data-fragment-index="1">+-----+-----+</span>-----+
                 <span class="fragment highlight-current-red" data-fragment-index="1">|  A  |  X  |</span>  Y  |
                 <span class="fragment highlight-current-red" data-fragment-index="1">+-----+-----+</span>-----+
                    <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
        /+--------- <span class="fragment highlight-current-red" data-fragment-index="1">|</span> --- <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span> (!s && !t)
        ||          <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
+----------+        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
| opcode|| |        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
| 100001<span class="fragment highlight-current-red" data-fragment-index="1">st</span> |<span
                         class="fragment highlight-current-red" data-fragment-index="1">------->t     |</span>     |
+----------+        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
     ^  <span class="fragment highlight-current-red" data-fragment-index="1">\---------- | --->s</span>     |
     |              <span class="fragment highlight-current-red" data-fragment-index="1">\     |</span>     /
     |               <span class="fragment highlight-current-red" data-fragment-index="1">\    |</span>    /
  select              write bus
   store
            </pre>
                </section>
                <section>
                    <h2>Inside the 6502</h2>
                    <table class="opcodes">
                        <tr>
                            <th>$84 10000100</th>
                            <td>STY zp</td>
                        </tr>
                        <tr>
                            <th>$85 10000101</th>
                            <td>STA zp</td>
                        </tr>
                        <tr>
                            <th>$86 10000110</th>
                            <td>STX zp</td>
                        </tr>
                        <tr>
                            <th>$87 10000111</th>
                            <td><b>SAX zp</b></td>
                        </tr>
                    </table>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>
                <section>
                    <h2>Even more games</h2>
                    <img src="Alien8.png" class="stretch">
                    <h4>An admission</h4>
                </section>
                <section>
                    <h2>Protection systems</h2>
                    <ul>
                        <li>Decrypt game code</li>
                        <li>Keys include:
                            <ul>
                                <li>Magic values loaded from tape (or disc)</li>
                                <li class="fragment">Decryption code itself</li>
                                <li class="fragment">Hardware timers &amp; registers</li>
                                <li class="fragment">Interrupt information</li>
                                <li class="fragment">Read-modify-write</li>
                            </ul>
                        </li>
                    </ul>
                    <aside class="notes">
                        Disc images mostly hacked
                        Doing tape support -> oh noes
                    </aside>
                </section>
                <section>
                    <h2>Accurate timing information</h2>
                    <h3><a href="http://visual6502.org/JSSim/expert.html?a=0&d=2e48fe" target="_blank">Visual 6502</a>
                    </h3>
                </section>
                <section>
                    <h2>ROL $fe48</h2>
                    <table class="rol">
                        <tr>
                            <th>Cycle</th>
                            <th>Read / Write</th>
                            <th>Address</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td>0</td>
                            <td>Read</td>
                            <td>0d2d</td>
                            <td>Read opcode (2e)</td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>Read</td>
                            <td>0d2e</td>
                            <td>Read low byte of address (48)</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Read</td>
                            <td>0d2f</td>
                            <td>Read high byte of address (fe)</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Read</td>
                            <td>fe48</td>
                            <td>Read memory at $fe48</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Write</td>
                            <td>fe48</td>
                            <td>Do rotate <span class="fragment" style="color: #ff2c2d;">&mdash; writes unmodified
                                    value!</span>
                            </td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Write</td>
                            <td>fe48</td>
                            <td>Store to $fe48</td>
                        </tr>
                    </table>
                </section>
                <section>
                    <h2>Fixing it</h2>
                    <pre><code class="javascript" data-trim data-noescape>
case 0x2e: // ROL abs
<div class="fragment highlight-current-code">  addr = readword(pc); pc += 2;
  hardware.run(3);
</div><div class="fragment highlight-current-code">  val = readbyte(addr);
  hardware.run(1);
</div><div class="fragment highlight-current-code">  writebyte(addr, val); // unmodified value
  hardware.run(1);
</div><div class="fragment highlight-current-code">  val = (val << 1) | (carry ? 1);
  carry = val & 0x100;
</div><div class="fragment highlight-current-code">  writebyte(addr, val & 0xff); // modified value
  hardware.run(1);
</div>  break;
                     </code></pre>
                </section>
                <section>
                    <h2>Cycle stretching</h2>
                    <div class="wavedrom">
                        <script type="WaveDrom">
{ signal : [
  { name: "CPU @ 2 MHz",  wave: "N......." },
  { name: "H/W @ 1 MHz",  wave: "N...", period: 2 },
  {                 node: "..A.B...", phase: 0.5 },
  { name: "Case 1", wave: "N.h.N..." },
  {                 node: "...CD...", phase: 0.5 },
  { name: "Case 2", wave: "N..hN..." }
],
edge: ['A-&gt;B stretch', 'C-&gt;D stretch']
}
                    </script>
                    </div>
                </section>
            </section>

            <!---------------------------------------------------------------------->
            <section>

                <section>
                    <h2>Conclusion</h2>
                    <img class="stretch" src="tt26.jpg">
                </section>
                <section>
                    <h2>Resources</h2>
                    <ul>
                        <li>Play: <a href="https://bbc.xania.org/">bbc.xania.org</a></li>
                        <li>Native client: <a
                                href="https://github.com/mattgodbolt/jsbeeb/releases">github.com/mattgodbolt/jsbeeb/releases</a>
                        </li>
                        <li>Source: <a href="https://github.com/mattgodbolt/jsbeeb">github.com/mattgodbolt/jsbeeb</a> </li>
                        <li>Special thanks to
                            <ul>
                                <li>Chris Evans, Rich Talbot-Watkins, Kieran Connell</li>
                                <li>Sarah Walker</li>
                                <li>Ed Spittles &amp; the Visual6502 team</li>
                                <li>Ian Bell</li>
                                <li>Kevin Edwards</li>
                                <li>the users on the <a href="http://www.stardot.org.uk/forums/">*. forums</a></li>
                            </ul>
                        </li>
                    </ul>
                </section>
            </section>
        </section>
    </div>

    <script src="reveal.js/lib/js/head.min.js"></script>
    <script src="reveal.js/js/reveal.js"></script>
    <script src="blink.js"></script>

    <script>

        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: false,
            progress: false,
            history: true,
            slideNumber: true,
            width: 1280,
            height: 720,

            transition: 'fade', // default/cube/page/concave/zoom/linear/fade/none

            // Optional libraries used to extend on reveal.js
            dependencies: [
                {
                    src: 'lib/js/classList.js',
                    condition: function () {
                        return !document.body.classList;
                    }
                },
                {
                    src: 'WaveDrom.js',
                    async: true,
                    callback: function () {
                        WaveDrom.ProcessAll();
                    }
                },
                {
                    src: 'reveal.js/plugin/highlight/highlight.js',
                    async: true,
                    callback: function () {
                        function asm6502() {
                            return {
                                k: {
                                    keyword: 'LDA LDX LDY STA STX STY INC INX INY DEC DEX DEY CMP CPX CPY BEQ BNE BMI BPL BCS BCC BVS BVC ' +
                                        'JMP JSR RTS RTI ASL ROL ROR PHP PHA PHX PHY PLP PLA PLX PLY TAX TAY TXA TYA TXS TSX ADC SBC ' +
                                        'SEC CLC SED CLD SEI CLI',
                                    built_in: 'A X Y'
                                },
                                c: [{ cN: 'comment', b: ';', e: '$' },
                                { cN: 'labeldef', b: '^\\.[a-zA-Z_][a-zA-Z_0-9]*' },
                                { cN: 'opcodes', b: '^[0-9a-f]{2}( [0-9a-f]{2})*' },
                                { cN: 'label', b: '[a-z][a-zA-Z]*' },
                                { cN: 'literal', b: '#?\\$?[0-9a-f]+' }]
                            };
                        }

                        hljs.registerLanguage("asm6502", asm6502);
                        hljs.initHighlightingOnLoad();
                    }
                },
                { src: 'lib/js/fullscreen-img.js' }
            ]
        });

    </script>

</body>

</html>