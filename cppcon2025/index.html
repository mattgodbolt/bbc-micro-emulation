<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="description" content="Emulating a BBC Micro - CppCon 2025" />
    <meta name="author" content="Matt Godbolt" />

    <title>Emulating a BBC Micro - CppCon 2025</title>

    <link rel="stylesheet" href="reveal.js/dist/reset.css" />
    <link rel="stylesheet" href="reveal.js/dist/reveal.css" />
    <link rel="stylesheet" href="reveal.js/dist/theme/night.css" />
    <link rel="stylesheet" href="reveal.js/plugin/highlight/zenburn.css" />

    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <!---------------------------------------------------------------------->
        <section>
          <section class="first">
            <h1>Emulating the<br />BBC&nbsp;Micro<br />in Javascript</h1>
            <h3>
              <a href="https://bsky.app/profile/matt.godbolt.org"
                >Matt Godbolt</a
              >
            </h3>
            <h3>CppCon 2025</h3>
          </section>
          <section>
            <h2 class="type-in">
              <span>Emulating the</span><br /><span>BBC&nbsp;Micro</span
              ><br /><span>in Javascript</span>
            </h2>
            <h4 class="type-in"><span>Matt Godbolt</span></h4>
            <h4 class="type-in"><span>CppCon 2025</span></h4>
            <h4 class="type-in">
              <span>Trying to recapture a lost youth</span>
            </h4>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>What's a BBC Micro?</h2>
            <img class="stretch" src="Beeb.jpeg" />
            <aside class="notes">
              <ul>
                <li>
                  Made by Acorn in 1981 as part of BBC Computer Literacy Project
                </li>
                <li>Acorn being the original A in ARM.</li>
                <li>2MHz 6502 CPU</li>
                <li>32KB RAM / 32KB ROM</li>
                <li>Memory-mapped hardware</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>Why BBC Micro?</h2>
            <div class="r-stack">
              <img class="fragment au-mag" src="AcornUser1.png" />
              <img class="fragment au-mag" src="AcornUser2.png" />
            </div>
          </section>
          <section>
            <h2>Why Javascript?</h2>
            <div class="">
              <ul class="fragment" data-fragment-index="1">
                <li>Surely it'd be too slow?</li>
                <li>"Worse" than C++?</li>
                <li>Why not?</li>
                <li class="fragment" data-fragment-index="2">
                  Runs in browser
                </li>
              </ul>
            </div>
            <div class="flex-grow">
              <img
                class="no-border fragment"
                data-fragment-index="2"
                src="Exile.png"
              />
            </div>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>The 6502</h2>
            <img class="stretch" src="MOS_6502_layers_top.png" />
            <aside class="notes">
              8-bit microprocessor; 3510 transistors, laid out by hand. First
              produced in 1975. Over 10 billion made so far
            </aside>
          </section>
          <section>
            <h2>6502 Computers</h2>
            <div class="flex computers">
              <img class="no-border" src="120px-Apple_iieb.jpg" />
              <img class="no-border" src="120px-Atari-2600-Console.jpg" />
              <img class="no-border" src="120px-Atari_800.jpg" />
              <img class="no-border" src="120px-BBC_Micro_Front_Restored.jpg" />
              <img
                class="no-border"
                src="120px-Commodore_2001_Series-IMG_0448b.jpg"
              />
              <img class="no-border" src="Commodore-VIC-20-FL.jpg" />
            </div>
            <div class="flex fragment computers">
              <img class="no-border big" src="TheTerminator.jpg" />
              <img class="no-border big" src="Bender.jpg" />
            </div>
            <aside class="notes">
              Apple IIe, Atari 2600, Atari 800, Beeb, Commodore PET & 64, VIC20.
              Brought about the 1980s computer revolution
            </aside>
          </section>
          <section>
            <h2>6502 101</h2>
            <aside class="notes">
              8-bit, 3 registers A X Y, 256-byte stack, ZP, PC. Ran at 2MHz on
              beeb
            </aside>
          </section>
          <section>
            <h2>Registers</h2>
            <ul class="registers">
              <li>8-bit <code>A</code>ccumulator</li>
              <li>8-bit <code>X</code>, <code>Y</code> index</li>
              <li><code>P</code>rocessor status</li>
              <li><code>S</code>tack pointer</li>
              <li>Program counter</li>
            </ul>
          </section>
          <section>
            <h2>Instructions</h2>
            <pre><code class="asm6502" data-trim>
LDA STA LDX ... ; load / store A, X, Y
TAX TXA ...     ; transfer A to X
PHA PLA         ; push A / pull A
CMP             ; compare with A
ADC SBC         ; add / subtract with carry
CLC SEC         ; clear / set carry
JMP             ; jump
BEQ BNE BCS BCC ; branch ==, !=, carry set/clear
BMI BPL ...     ; &lt;0, &gt;=0
JSR             ; jump to subroutine
RTS             ; return from subroutine
                     </code></pre>
          </section>
          <section>
            <h2>Addressing modes</h2>
            <pre><code class="asm6502" data-trim>
a9 20     LDA #$20     ; A = 0x20

a5 70     LDA $70      ; A = readmem(0x70)

ad 34 12  LDA $1234    ; A = readmem(0x1234)
                     </code></pre>
          </section>
          <section>
            <h2>Addressing modes</h2>
            <pre><code class="asm6502" data-trim>
bd 34 12  LDA $1234, X ; A = readmem(0x1234 + X)
b9 34 12  LDA $1234, Y ; A = readmem(0x1234 + Y)

b1 70     LDA ($70), Y ; t1 = readmem(0x70)
                       ; t2 = readmem(0x71)
                       ; addr = t1 | (t2&lt;&lt;8)
                       ; A = readmem(addr + Y)

b5 70     LDA $70, X   ; A = readmem(0x70 + X)
                     </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Emulating a 6502</h2>
            <ul class="fragment">
              <li>Fetch next instruction</li>
              <li>Decode it</li>
              <li>Execute it</li>
            </ul>
          </section>
          <section>
            <h2>Emulation</h2>
            <pre><code class="javascript" data-trim data-line-numbers="|1|3|4-5|6-9|">
var a = 0, x = 0, y = 0, pc = readword(0xfffe);
while (true) {
  switch (readmem(pc++)) {
  case 0xa9: // LDA #imm
    a = readmem(pc++); break;
  case 0xad: // LDA $addr
    var addr = readword(pc); pc += 2;
    a = readmem(addr);
    break;
  // and so on for all other instructions...
  }
}
</code></pre>
          </section>
          <section>
            <h2>Except...</h2>
            <ul>
              <li>Setting flags</li>
              <li>Memory access</li>
              <li>Hardware</li>
              <li>Interrupts</li>
              <li>Handling time</li>
            </ul>
          </section>
          <section>
            <h2>Processor status: Flags</h2>
            <table class="horizontal">
              <thead>
                <tr>
                  <th>7</th>
                  <th>6</th>
                  <th>5</th>
                  <th>4</th>
                  <th>3</th>
                  <th>2</th>
                  <th>1</th>
                  <th>0</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Negative</td>
                  <td>oVerflow</td>
                  <td>-</td>
                  <td>-</td>
                  <td>Decimal</td>
                  <td>Interrupt<br />disable</td>
                  <td>Zero</td>
                  <td>Carry</td>
                </tr>
              </tbody>
            </table>
            <br />
            <ul class="fragment">
              <li>Z &amp; N set on ALU/load instruction</li>
              <li>C set by shifts &amp; arithmetic</li>
              <li>V set by arithmetic</li>
              <li>D, V, C and I controlled by special instructions</li>
            </ul>
          </section>
          <section>
            <h2>So now we have:</h2>
            <pre><code class="javascript" data-trim>
case 0xa9: // LDA #imm
  a = readmem(pc++);
  p.z = !a;
  p.n = !!(a &amp; 0x80);
  break;             </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Memory</h2>
            <table class="memmap">
              <tbody>
                <tr>
                  <th style="width: 30%">0x10000</th>
                  <td></td>
                </tr>
                <tr class="osrom">
                  <th>0xff00</th>
                  <td>256 bytes OS ROM</td>
                </tr>
                <tr class="hw">
                  <th>0xfe00</th>
                  <td>256 bytes hardware</td>
                </tr>
                <tr class="osrom">
                  <th>0xfd00</th>
                  <td>256 bytes ROM</td>
                </tr>
                <tr class="hw">
                  <th>0xfc00</th>
                  <td>256 bytes hardware</td>
                </tr>
                <tr class="osrom">
                  <th>&uarr;<br />&uarr;<br />&uarr;<br />0xc000</th>
                  <td>15.5KB OS ROM</td>
                </tr>
                <tr class="rom1">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x8000
                  </th>
                  <td>16KB Paged ROM</td>
                </tr>
                <tr class="ram2">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x4000
                  </th>
                  <td>16KB RAM</td>
                </tr>
                <tr class="ram1">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x0000
                  </th>
                  <td>16KB RAM</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <h2>Memory - Reading</h2>
            <pre><code class="javascript" data-trim data-line-numbers="|1|2-3|6|7|8-10|11|">
var ram = new Uint8Array(0x8000), romsel = 0, roms = [];
var os = load("OS");
roms[15] = load("BASIC");

function readmem(addr) {
  if (addr &lt; 0x8000) return ram[addr];
  if (addr &lt; 0xc000) return roms[romsel][addr - 0x8000];
  if ((addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00)
      || (addr &gt;= 0xfc00 &amp;&amp; addr &lt; 0xfd00))
    return readhw(addr);
  return os[addr - 0xc000];
}
                         </code></pre>
          </section>
          <section>
            <h2>Memory - Writing</h2>
            <pre><code class="javascript" data-trim data-line-numbers="|2|3|">
function writemem(addr, b) {
    if (addr &lt; 0x8000) ram[addr] = b;
    if (addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00) writehw(addr, b);
    // else does nothing - it's ROM
}
                         </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>The outside world</h2>
            <ul>
              <li class="fragment">
                Video chip:
                <ul>
                  <li>Pixel generator reads from RAM</li>
                  <li>Simple character-mapped mode</li>
                  <li>Bitmap modes with 2, 4, 16 colours</li>
                </ul>
              </li>
              <li class="fragment">Sound (SN76489)</li>
              <li class="fragment">Timers (6522 VIA)</li>
            </ul>
          </section>
          <section>
            <h2>
              <a
                href="https://bbc.xania.org/?videoCyclesBatch=8000&disc=Welcome.ssd&keyLayout=physical"
                >Demo</a
              >
            </h2>
            <aside class="notes">
              <ul>
                <li>Show MODE 7, another video mode.</li>
                <li>Show "hello world"</li>
                <li>Load up welcome, run kingdom?</li>
                <li>Run Elite...oh noes</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>What happened?</h2>
            <img src="BrokenElite.png" class="stretch" />
          </section>
          <section>
            <h2>Fixing it</h2>
            <pre><code class="javascript" data-trim data-line-numbers="|2-4|5|6|">
case 0xa9: // LDA #imm
  a = readmem(pc++);
  p.z = !a;
  p.n = !!(a & 0x80);
  video.run(2);
  timers.run(2);
  break;
</code></pre>

            <h3 class="fragment">
              <a
                href="https://bbc.xania.org/?disc=elite.ssd&autoboot&keyLayout=physical"
                >Demo</a
              >
            </h3>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>More games</h2>
            <img src="Zalaga.png" class="stretch" />
            <h3>
              <a
                href="https://bbc.xania.org/?disc=Zalaga.ssd&autoboot&keyLayout=gaming&model=Master"
                >Zalaga</a
              >
            </h3>
            <aside class="notes">
              Fun part of emulation! e.g. address $1114. SAX zp instruction.
              show debugger
            </aside>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <ul>
              <table class="opcodes">
                <tr>
                  <th>
                    $84 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >00</span
                    >
                  </th>
                  <td>STY zp</td>
                </tr>
                <tr>
                  <th>
                    $85 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >01</span
                    >
                  </th>
                  <td>STA zp</td>
                </tr>
                <tr>
                  <th>
                    $86 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >10</span
                    >
                  </th>
                  <td>STX zp</td>
                </tr>
                <tr>
                  <th>
                    $87 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >11</span
                    >
                  </th>
                  <td>???</td>
                </tr>
              </table>
            </ul>
          </section>
          <section>
            <h2>Real decoding</h2>
            <img src="6502_pad_annot_07.png" class="stretch" />
            <div class="credit">
              &copy;2010 Visual6502.org, used with permission
            </div>
            <aside class="notes">
              Thanks to Visual 6502 people!<br />
              PLA is a 130x21 ROM, indexed by 8 instr bits + ~bits (minus one),
              and 6 bits of T-state.. output is 130 bits that enable various
              parts of the chip. SAX enables both "A" and "X" parts NMOS
              transistors drain? something?
            </aside>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <div class="decode-diagram">
              <svg
                width="800"
                height="400"
                viewBox="0 0 800 400"
                xmlns="http://www.w3.org/2000/svg"
                class="stretch"
              >
                <!-- Register boxes at top - positioned for orthogonal lines -->
                <rect
                  x="145"
                  y="30"
                  width="80"
                  height="40"
                  class="register-box fragment highlight-current-blue"
                  data-fragment-index="3"
                />
                <text x="185" y="50" class="register-label fragment highlight-current-blue" data-fragment-index="3">X</text>

                <rect
                  x="340"
                  y="30"
                  width="80"
                  height="40"
                  class="register-box fragment highlight-current-blue"
                  data-fragment-index="2"
                />
                <text x="380" y="50" class="register-label fragment highlight-current-blue" data-fragment-index="2">A</text>

                <rect
                  x="540"
                  y="30"
                  width="80"
                  height="40"
                  class="register-box fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <text x="580" y="50" class="register-label fragment highlight-current-blue" data-fragment-index="1">Y</text>

                <!-- Bus lines from registers -->
                <line x1="185" y1="70" x2="185" y2="120" class="bus-line fragment highlight-current-blue" data-fragment-index="3" />
                <line x1="380" y1="70" x2="380" y2="120" class="bus-line fragment highlight-current-blue" data-fragment-index="2" />
                <line x1="580" y1="70" x2="580" y2="120" class="bus-line fragment highlight-current-blue" data-fragment-index="1" />

                <!-- Transistors as visible switches -->
                <!-- X transistor switch (controlled by s) -->
                <rect
                  x="175"
                  y="120"
                  width="20"
                  height="30"
                  class="transistor fragment highlight-current-blue"
                  data-fragment-index="3"
                />
                <circle cx="185" cy="135" r="8" class="transistor fragment highlight-current-blue" data-fragment-index="3" />
                <line
                  x1="155"
                  y1="135"
                  x2="177"
                  y2="135"
                  class="control-line"
                />
                <text x="135" y="140" class="bit-label fragment highlight-current-blue" data-fragment-index="3">s</text>

                <!-- A transistor switch (controlled by t) -->
                <rect
                  x="370"
                  y="120"
                  width="20"
                  height="30"
                  class="transistor fragment highlight-current-blue"
                  data-fragment-index="2"
                />
                <circle cx="380" cy="135" r="8" class="transistor fragment highlight-current-blue" data-fragment-index="2" />
                <text x="345" y="140" class="bit-label fragment highlight-current-blue" data-fragment-index="2">t</text>

                <!-- Y transistor switch (controlled by !s&&!t) -->
                <rect
                  x="570"
                  y="120"
                  width="20"
                  height="30"
                  class="transistor fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <circle cx="580" cy="135" r="8" class="transistor fragment highlight-current-blue" data-fragment-index="1" />

                <!-- Continue bus lines after transistors -->
                <line x1="185" y1="150" x2="185" y2="200" class="bus-line fragment highlight-current-blue" data-fragment-index="3" />
                <line x1="380" y1="150" x2="380" y2="200" class="bus-line fragment highlight-current-blue" data-fragment-index="2" />
                <line x1="580" y1="150" x2="580" y2="200" class="bus-line fragment highlight-current-blue" data-fragment-index="1" />

                <!-- Horizontal bus wire connecting all three outputs -->
                <line x1="185" y1="200" x2="650" y2="200" class="bus-line" />
                <circle cx="185" cy="200" r="5" fill="#ddd" />
                <circle cx="380" cy="200" r="5" fill="#ddd" />
                <circle cx="580" cy="200" r="5" fill="#ddd" />
                <text x="660" y="205" class="opcode-text">write bus</text>

                <!-- Opcode box -->
                <rect
                  x="5"
                  y="250"
                  width="175"
                  height="50"
                  class="register-box"
                />
                <text x="60" y="270" class="opcode-text">opcode:</text>
                <text x="20" y="290" class="opcode-text">1</text>
                <text x="40" y="290" class="opcode-text">0</text>
                <text x="60" y="290" class="opcode-text">0</text>
                <text x="80" y="290" class="opcode-text">0</text>
                <text x="100" y="290" class="opcode-text">0</text>
                <text x="120" y="290" class="opcode-text">1</text>
                <text x="140" y="290" class="bit-label fragment highlight-current-blue" data-fragment-index="3">s</text>
                <text x="160" y="290" class="bit-label fragment highlight-current-blue" data-fragment-index="2">t</text>

                <!-- Control lines from s and t bits to transistors -->
                <!-- s to X -->
                <line
                  x1="145"
                  y1="290"
                  x2="145"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="3"
                />
                <line
                  x1="145"
                  y1="135"
                  x2="177"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="3"
                />

                <!-- t to A -->
                <line
                  x1="165"
                  y1="290"
                  x2="165"
                  y2="170"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="2"
                />
                <line
                  x1="165"
                  y1="170"
                  x2="325"
                  y2="170"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="2"
                />
                <line
                  x1="325"
                  y1="170"
                  x2="325"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="2"
                />
                <line
                  x1="325"
                  y1="135"
                  x2="370"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="2"
                />

                <!-- Logic for Y control (!s && !t) -->
                <!-- NOT gate for s -->
                <path
                  d="M 320,310 L 340,320 L 320,330 Z"
                  class="gate-outline fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <circle cx="344" cy="320" r="4" class="gate-outline fragment highlight-current-blue" data-fragment-index="1" />
                <line
                  x1="145"
                  y1="295"
                  x2="145"
                  y2="320"
                  class="control-line"
                />
                <line
                  x1="145"
                  y1="320"
                  x2="320"
                  y2="320"
                  class="control-line"
                />

                <!-- NOT gate for t -->
                <path
                  d="M 320,340 L 340,350 L 320,360 Z"
                  class="gate-outline fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <circle cx="344" cy="350" r="4" class="gate-outline fragment highlight-current-blue" data-fragment-index="1" />
                <line
                  x1="165"
                  y1="295"
                  x2="165"
                  y2="350"
                  class="control-line"
                />
                <line
                  x1="165"
                  y1="350"
                  x2="320"
                  y2="350"
                  class="control-line"
                />

                <!-- AND gate -->
                <path
                  d="M 380,315 L 380,355 L 400,355 Q 420,335 400,315 Z"
                  class="gate-outline fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <!-- Connect NOT outputs to AND inputs -->
                <line
                  x1="348"
                  y1="320"
                  x2="380"
                  y2="320"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <line
                  x1="348"
                  y1="350"
                  x2="380"
                  y2="350"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="1"
                />

                <!-- AND output to Y transistor -->
                <line
                  x1="410"
                  y1="335"
                  x2="540"
                  y2="335"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <line
                  x1="540"
                  y1="335"
                  x2="540"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <line
                  x1="540"
                  y1="135"
                  x2="570"
                  y2="135"
                  class="control-line fragment highlight-current-blue"
                  data-fragment-index="1"
                />
                <text x="500" y="140" class="bit-label fragment highlight-current-blue" data-fragment-index="1">!s&amp;&amp;!t</text>

                <!-- Fragment 4: SAX demonstration overlays (both A and X active) -->
                <!-- X register highlights -->
                <rect x="145" y="30" width="80" height="40" 
                      class="fragment highlight-current-red" 
                      data-fragment-index="4" 
                      fill="none"/>
                <text x="185" y="50" 
                      class="register-label register-label-red fragment" 
                      data-fragment-index="4"
                     >X</text>
                <rect x="175" y="120" width="20" height="30"
                      class="transistor transistor-red fragment"
                      data-fragment-index="4"
                     />
                <circle cx="185" cy="135" r="8"
                        class="transistor transistor-red fragment"
                        data-fragment-index="4"
                       />
                <line x1="185" y1="70" x2="185" y2="120"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="185" y1="150" x2="185" y2="200"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="145" y1="290" x2="145" y2="135"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="145" y1="135" x2="177" y2="135"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>

                <!-- A register highlights -->
                <rect x="340" y="30" width="80" height="40"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      fill="none"/>
                <text x="380" y="50"
                      class="register-label register-label-red fragment"
                      data-fragment-index="4"
                     >A</text>
                <rect x="370" y="120" width="20" height="30"
                      class="transistor transistor-red fragment"
                      data-fragment-index="4"
                     />
                <circle cx="380" cy="135" r="8"
                        class="transistor transistor-red fragment"
                        data-fragment-index="4"
                       />
                <line x1="380" y1="70" x2="380" y2="120"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="380" y1="150" x2="380" y2="200"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="165" y1="290" x2="165" y2="170"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="165" y1="170" x2="325" y2="170"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="325" y1="170" x2="325" y2="135"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>
                <line x1="325" y1="135" x2="370" y2="135"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke="none"/>

                <!-- Bus line highlighting for each fragment -->
                <!-- Fragment 1: Y output (rightmost section) -->
                <line x1="580" y1="200" x2="650" y2="200"
                      class="fragment highlight-current-blue"
                      data-fragment-index="1"
                      stroke-width="3"/>
                
                <!-- Fragment 2: A output (middle to end) -->
                <line x1="380" y1="200" x2="650" y2="200"
                      class="fragment highlight-current-blue"
                      data-fragment-index="2"
                      stroke-width="3"/>
                
                <!-- Fragment 3: X output (leftmost to end) -->
                <line x1="185" y1="200" x2="650" y2="200"
                      class="fragment highlight-current-blue"
                      data-fragment-index="3"
                      stroke-width="3"/>
                
                <!-- Fragment 4: Both outputs (entire line) -->
                <line x1="185" y1="200" x2="650" y2="200"
                      class="fragment highlight-current-red"
                      data-fragment-index="4"
                      stroke-width="3"/>
                
                <!-- Circle highlighting overlays for each fragment -->
                <!-- Fragment 1: Y node -->
                <circle cx="580" cy="200" r="5"
                        class="fragment fade-in-then-out"
                        data-fragment-index="1"
                        fill="#4488ff"/>
                
                <!-- Fragment 2: A node -->
                <circle cx="380" cy="200" r="5"
                        class="fragment fade-in-then-out"
                        data-fragment-index="2"
                        fill="#4488ff"/>
                
                <!-- Fragment 3: X node -->
                <circle cx="185" cy="200" r="5"
                        class="fragment fade-in-then-out"
                        data-fragment-index="3"
                        fill="#4488ff"/>
                
                <!-- Fragment 4: Both X and A nodes -->
                <circle cx="185" cy="200" r="5" 
                        class="fragment"
                        data-fragment-index="4"
                        fill="#ff4444"/>
                <circle cx="380" cy="200" r="5"
                        class="fragment"
                        data-fragment-index="4"
                        fill="#ff4444"/>

                <!-- Output indicator boxes -->
                <g>
                  <rect x="660" y="215" width="40" height="30"
                        class="register-box"/>
                  <text x="680" y="235" 
                        class="register-label fragment fade-in-then-out"
                        data-fragment-index="1">Y</text>
                  <text x="680" y="235"
                        class="register-label fragment fade-in-then-out"
                        data-fragment-index="2">A</text>
                  <text x="680" y="235"
                        class="register-label fragment fade-in-then-out"
                        data-fragment-index="3">X</text>
                  <text x="680" y="235"
                        class="register-label fragment"
                        data-fragment-index="4">???</text>
                </g>
              </svg>
            </div>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <!-- claude here -->
            <svg width="400" height="500" viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg">
              <!-- Vdd at top -->
              <text x="200" y="30" class="register-label">Vdd</text>
              <line x1="200" y1="40" x2="200" y2="80" class="bus-line"/>
              
              <!-- Resistor (pullup) -->
              <path d="M 200,80 l 0,10 l -10,5 l 20,10 l -20,10 l 20,10 l -20,10 l 20,10 l -10,5 l 0,10" class="gate-outline"/>
              
              <!-- Wire from resistor to output branch point -->
              <line x1="200" y1="150" x2="200" y2="200" class="bus-line"/>
              
              <!-- Branch to output -->
              <circle cx="200" cy="200" r="5" fill="#ddd"/>
              <line x1="200" y1="200" x2="320" y2="200" class="bus-line"/>
              <text x="340" y="200" class="register-label" dominant-baseline="middle">out</text>
              
              <!-- NMOS transistor -->
              <!-- Gate connection from left with dotted line -->
              <line x1="80" y1="280" x2="160" y2="280" class="control-line"/>
              <text x="60" y="280" class="register-label" text-anchor="end" dominant-baseline="middle">in</text>
              
              <!-- Transistor symbol - N-channel MOSFET -->
              <!-- Gate (vertical flat line on left) -->
              <line x1="160" y1="250" x2="160" y2="310" class="transistor"/>
              
              <!-- Channel (vertical flat line on right, slightly longer) -->
              <line x1="180" y1="240" x2="180" y2="320" class="transistor"/>
              
              <!-- Drain connection: from output node, step in to channel top -->
              <line x1="200" y1="200" x2="200" y2="240" class="bus-line"/>
              <line x1="200" y1="240" x2="180" y2="240" class="transistor"/>
              
              <!-- Source connection: from channel bottom, step out, then to ground -->
              <line x1="180" y1="320" x2="200" y2="320" class="transistor"/>
              <line x1="200" y1="320" x2="200" y2="380" class="bus-line"/>
              
              <!-- Ground -->
              <line x1="200" y1="380" x2="200" y2="420" class="bus-line"/>
              <!-- Ground symbol -->
              <line x1="180" y1="420" x2="220" y2="420" class="gate-outline"/>
              <line x1="185" y1="430" x2="215" y2="430" class="gate-outline"/>
              <line x1="190" y1="440" x2="210" y2="440" class="gate-outline"/>
              <text x="200" y="465" class="register-label">GND</text>
            </svg>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <table class="opcodes">
              <tr>
                <th>$84 10000100</th>
                <td>STY zp</td>
              </tr>
              <tr>
                <th>$85 10000101</th>
                <td>STA zp</td>
              </tr>
              <tr>
                <th>$86 10000110</th>
                <td>STX zp</td>
              </tr>
              <tr>
                <th>$87 10000111</th>
                <td><b>SAX zp</b></td>
              </tr>
            </table>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Even more games</h2>
            <img src="Alien8.png" class="stretch" />
            <h4>An admission</h4>
          </section>
          <section>
            <h2>Protection systems</h2>
            <ul>
              <li>Decrypt game code</li>
              <li>
                Keys include:
                <ul>
                  <li>Magic values loaded from tape (or disc)</li>
                  <li class="fragment">Decryption code itself</li>
                  <li class="fragment">Hardware timers &amp; registers</li>
                  <li class="fragment">Interrupt information</li>
                  <li class="fragment">Read-modify-write</li>
                </ul>
              </li>
            </ul>
            <aside class="notes">
              Disc images mostly hacked Doing tape support -> oh noes
            </aside>
          </section>
          <section>
            <h2>Accurate timing information</h2>
            <h3>
              <a href="http://visual6502.org/JSSim/expert.html?a=0&d=2e48fe"
                >Visual 6502</a
              >
            </h3>
          </section>
          <section>
            <h2>ROL $fe48</h2>
            <table class="rol">
              <tr>
                <th>Cycle</th>
                <th>Read / Write</th>
                <th>Address</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>0</td>
                <td>Read</td>
                <td>0d2d</td>
                <td>Read opcode (2e)</td>
              </tr>
              <tr>
                <td>1</td>
                <td>Read</td>
                <td>0d2e</td>
                <td>Read low byte of address (48)</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Read</td>
                <td>0d2f</td>
                <td>Read high byte of address (fe)</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Read</td>
                <td>fe48</td>
                <td>Read memory at $fe48</td>
              </tr>
              <tr>
                <td>4</td>
                <td>Write</td>
                <td>fe48</td>
                <td>
                  Do rotate
                  <span class="fragment" style="color: #ff2c2d"
                    >&mdash; writes unmodified value!</span
                  >
                </td>
              </tr>
              <tr>
                <td>5</td>
                <td>Write</td>
                <td>fe48</td>
                <td>Store to $fe48</td>
              </tr>
            </table>
          </section>
          <section>
            <h2>Fixing it</h2>
            <pre><code class="javascript" data-trim data-line-numbers="|2-3|4-5|6-7|8-9|10-11|">
case 0x2e: // ROL abs
  addr = readword(pc); pc += 2;
  hardware.run(3);
  val = readbyte(addr);
  hardware.run(1);
  writebyte(addr, val); // unmodified value
  hardware.run(1);
  val = (val &lt;&lt; 1) | (carry ? 1);
  carry = val & 0x100;
  writebyte(addr, val & 0xff); // modified value
  hardware.run(1);
  break;
</code></pre>
          </section>
          <section>
            <h2>Cycle stretching</h2>
            <div class="wavedrom">
              <script type="WaveDrom">
                { signal : [
                  { name: "CPU @ 2 MHz",  wave: "N......." },
                  { name: "H/W @ 1 MHz",  wave: "N...", period: 2 },
                  {                 node: "..A.B...", phase: 0.5 },
                  { name: "Case 1", wave: "N.h.N..." },
                  {                 node: "...CD...", phase: 0.5 },
                  { name: "Case 2", wave: "N..hN..." }
                ],
                edge: ['A-&gt;B stretch', 'C-&gt;D stretch']
                }
              </script>
            </div>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Conclusion</h2>
            <img class="stretch" src="tt26.jpg" />
          </section>
          <section>
            <h2>Resources</h2>
            <ul>
              <li>
                <a href="https://bbc.xania.org/">https://bbc.xania.org/</a>
              </li>
              <li>
                Source on
                <a href="https://github.com/mattgodbolt/jsbeeb"
                  >github.com/mattgodbolt/jsbeeb</a
                >
              </li>
              <li>
                <a href="http://visual6502.org">http://visual6502.org/</a>
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/EvilIn11.ssd&autoboot&model=Master"
                  >Bitshifters' latest demo</a
                >
              </li>
            </ul>
          </section>
          <section>
            <h2>Some Demos</h2>
            <ul>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/bs-scr-beeb.ssd&autoboot&model=Master"
                >
                  Stunt Car Racer
                </a>
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/crtc-somenastyeffects.ssd&autoboot&model=Master"
                  >Some Nasty Effects</a
                >
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/TheMaster-Demo128.ssd&autoboot&model=Master"
                  >The Master</a
                >
              </li>
              <!--<li><a href="http://localhost/jsbeeb/?disc=Blurp.ssd&autoboot&keyLayout=physical">Blurp</a></li>-->
              <li><a href="https://bitshifters.github.io/">Bitshifters</a></li>
            </ul>
          </section>
        </section>
      </div>
      <div class="footer">
        <div class="footer-img"><img src="ce.svg" /></div>
        <div>
          &copy; 2025 Matt Godbolt - CppCon 2025
          <a
            href="https://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1"
            >CC BY-NC 4.0</a
          >
        </div>
      </div>
    </div>

    <script src="default.js" type="text/javascript"></script>
    <script src="WaveDrom.js"></script>
    <script type="module">
      import Reveal from "./reveal.js/dist/reveal.esm.js";
      import Highlight from "./reveal.js/plugin/highlight/highlight.esm.js";
      import TypingEffect from "./typing-effect.js";

      // Define custom 6502 assembly language for syntax highlighting
      function asm6502() {
        return {
          keywords: {
            keyword:
              "LDA LDX LDY STA STX STY INC INX INY DEC DEX DEY CMP CPX CPY BEQ BNE BMI BPL BCS BCC BVS BVC " +
              "JMP JSR RTS RTI ASL ROL ROR PHP PHA PHX PHY PLP PLA PLX PLY TAX TAY TXA TYA TXS TSX ADC SBC " +
              "SEC CLC SED CLD SEI CLI",
            built_in: "A X Y",
          },
          contains: [
            { className: "comment", begin: ";", end: "$" },
            { className: "labeldef", begin: "^\\.[a-zA-Z_][a-zA-Z_0-9]*" },
            { className: "opcodes", begin: "^[0-9a-f]{2}( [0-9a-f]{2})*" },
            { className: "label", begin: "[a-z][a-zA-Z]*" },
            { className: "literal", begin: "#?\\$?[0-9a-f]+" },
          ],
        };
      }

      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        slideNumber: true,
        width: 1920,
        height: 720,
        transition: "fade",
        highlight: {
          beforeHighlight: (hljs) => hljs.registerLanguage("asm6502", asm6502),
        },
        plugins: [Highlight, TypingEffect],
      });

      // Process timing diagrams
      WaveDrom.ProcessAll();
    </script>
  </body>
</html>
