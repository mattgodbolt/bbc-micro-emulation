<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="description" content="Emulating a BBC Micro - CppCon 2025" />
    <meta name="author" content="Matt Godbolt" />

    <title>Emulating a BBC Micro - CppCon 2025</title>

    <link rel="stylesheet" href="reveal.js/dist/reset.css" />
    <link rel="stylesheet" href="reveal.js/dist/reveal.css" />
    <link rel="stylesheet" href="reveal.js/dist/theme/night.css" />
    <link rel="stylesheet" href="reveal.js/plugin/highlight/zenburn.css" />
    <link rel="stylesheet" href="lib/css/fullscreen-img.css" />

    <!-- Print CSS is now handled automatically by modern reveal.js -->
    <style>
      @font-face {
        font-family: "Teletext";
        src: url("teletext.ttf");
      }

      .no-border {
        border: none !important;
        box-shadow: none !important;
      }

      div.footer {
        position: absolute;
        height: 64px;
        width: 100%;
        bottom: 0;
        background: #929292;
        border-top: 1px solid #b9b9b9;
        padding: 10px;
        display: flex;
        align-items: center;
      }
      div.footer-img img {
        width: 64px;
      }

      span.cursor::before {
        content: "\2588";
      }

      span.cursor.blink {
        opacity: 0;
      }

      .hidden {
        display: none !important;
      }

      div.flex {
        display: flex;
        justify-content: space-around;
      }

      .w40 {
        width: 40%;
      }

      img.au-mag {
        height: 550px;
      }

      .reveal {
        font-size: 30px;
      }

      .reveal h1,
      .reveal h2,
      .reveal h3,
      .reveal h4,
      .reveal h5,
      .reveal h6 {
        font-family: "Teletext", Impact, sans-serif;
      }

      .reveal .teletext {
        font-family: "Teletext", Impact, sans-serif;
      }

      .reveal .slides section .fragment.highlight-current-code {
        opacity: 1;
        visibility: inherit;
      }

      .reveal
        .slides
        section
        .fragment.highlight-current-code.current-fragment {
        background: #555a5f;
        color: #ffffff;
      }

      .registers code {
        text-decoration: underline;
      }

      div.computers img {
        height: 150px;
      }

      div.computers img.big {
        height: 300px;
      }

      table.rol {
        font-size: smaller;
      }

      table.horizontal {
        border-collapse: collapse;
      }

      table.horizontal th,
      table.horizontal td {
        border: 1px solid grey;
        text-align: center;
        width: 6em;
      }

      table.horizontal th:nth-child(even) {
        background-color: #444;
      }

      table.horizontal th:nth-child(odd) {
        background-color: #222;
      }

      table.horizontal td:nth-child(even) {
        background-color: #444;
      }

      table.horizontal td:nth-child(odd) {
        background-color: #222;
      }

      table.opcodes th {
        font-family: monospace;
      }

      div.credit {
        font-size: small;
      }

      div.wavedrom {
        background: #ffffff;
      }

      table.memmap {
        width: 50%;
        font-size: 0.6em;
      }

      table.memmap th {
        width: 6em;
        font-family: monospace;
        font-weight: normal;
        text-align: center;
      }

      table.memmap .addr {
        font-family: monospace;
      }

      table.memmap td {
        vertical-align: middle;
      }

      table.memmap tr.osrom {
        background-color: #222244;
      }

      table.memmap tr.hw {
        background-color: #444433;
      }

      table.memmap tr.rom1 {
        background-color: #222233;
      }

      table.memmap tr.ram1 {
        background-color: #223322;
      }

      table.memmap tr.ram2 {
        background-color: #283828;
      }

      code.asm6502,
      code.javascript {
        font-size: 22pt;
        line-height: 110%;
      }

      .first h1,
      .first h2,
      .first h3,
      .first h4 {
        font-family: "Helvetica", sans-serif;
      }

      .first h1 {
        font-size: 4em;
        font-weight: bold;
      }

      .first h2 {
        font-size: 2.5em;
        font-weight: bold;
      }

      .first h3 {
        font-size: 2em;
        font-style: italic;
      }
    </style>
    <script src="default.js" type="text/javascript"></script>
  </head>

  <body>
    <div class="reveal">
      <section class="slides">
        <!---------------------------------------------------------------------->
        <section>
          <section class="first">
            <h1>Emulating the<br />BBC&nbsp;Micro<br />in Javascript</h1>
            <h3><a href="https://bsky.app/profile/matt.godbolt.org">Matt Godbolt</a></h3>
            <h3>CppCon 2025</h3>
          </section>
          <section>
            <h2 class="type-in">
              <span>Emulating the</span><br /><span>BBC&nbsp;Micro</span
              ><br /><span>in Javascript</span>
            </h2>
            <h4 class="type-in"><span>Matt Godbolt</span></h4>
            <h4 class="type-in"><span>CppCon 2025</span></h4>
            <h4 class="type-in">
              <span>Trying to recapture a lost youth</span>
            </h4>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>What's a BBC Micro?</h2>
            <img class="stretch" src="Beeb.jpeg" />
            <aside class="notes">
              <ul>
                <li>
                  Made by Acorn in 1981 as part of BBC Computer Literacy Project
                </li>
                <li>Acorn being the original A in ARM.</li>
                <li>2MHz 6502 CPU</li>
                <li>32KB RAM / 32KB ROM</li>
                <li>Memory-mapped hardware</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>Why BBC Micro?</h2>
            <img class="fragment au-mag" src="AcornUser1.png" />
          </section>
          <section>
            <h2>Why BBC Micro?</h2>
            <img src="AcornUser2.png" class="au-mag" />
          </section>
          <section>
            <h2>Why Javascript?</h2>
            <div class="flex">
              <div class="">
                <ul class="fragment" data-fragment-index="1">
                  <li>Surely it'd be too slow?</li>
                  <li>"Worse" than C++?</li>
                  <li>Why not?</li>
                  <li class="fragment" data-fragment-index="2">
                    Runs in browser
                  </li>
                </ul>
              </div>
              <div class="">
                <img
                  class="no-border fragment"
                  data-fragment-index="2"
                  src="Exile.png"
                />
              </div>
            </div>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>The 6502</h2>
            <img class="stretch" src="MOS_6502_layers_top.png" />
            <aside class="notes">
              8-bit microprocessor; 3510 transistors, laid out by hand. First
              produced in 1975. Over 10 billion made so far
            </aside>
          </section>
          <section>
            <h2>6502 Computers</h2>
            <div class="flex computers">
              <img class="no-border" src="120px-Apple_iieb.jpg" />
              <img class="no-border" src="120px-Atari-2600-Console.jpg" />
              <img class="no-border" src="120px-Atari_800.jpg" />
              <img class="no-border" src="120px-BBC_Micro_Front_Restored.jpg" />
              <img
                class="no-border"
                src="120px-Commodore_2001_Series-IMG_0448b.jpg"
              />
              <img class="no-border" src="Commodore-VIC-20-FL.jpg" />
            </div>
            <div class="flex fragment computers">
              <img class="no-border big" src="TheTerminator.jpg" />
              <img class="no-border big" src="Bender.jpg" />
            </div>
            <aside class="notes">
              Apple IIe, Atari 2600, Atari 800, Beeb, Commodore PET & 64, VIC20.
              Brought about the 1980s computer revolution
            </aside>
          </section>
          <section>
            <h2>6502 101</h2>
            <aside class="notes">
              8-bit, 3 registers A X Y, 256-byte stack, ZP, PC. Ran at 2MHz on
              beeb
            </aside>
          </section>
          <section>
            <h2>Registers</h2>
            <ul class="registers">
              <li>8-bit <code>A</code>ccumulator</li>
              <li>8-bit <code>X</code>, <code>Y</code> index</li>
              <li><code>P</code>rocessor status</li>
              <li><code>S</code>tack pointer</li>
              <li>Program counter</li>
            </ul>
          </section>
          <section>
            <h2>Instructions</h2>
            <pre><code class="asm6502" data-trim>
LDA STA LDX ... ; load / store A, X, Y
TAX TXA ...     ; transfer A to X
PHA PLA         ; push A / pull A
CMP             ; compare with A
ADC SBC         ; add / subtract with carry
CLC SEC         ; clear / set carry
JMP             ; jump
BEQ BNE BCS BCC ; branch ==, !=, carry set/clear
BMI BPL ...     ; &lt;0, &gt;=0
JSR             ; jump to subroutine
RTS             ; return from subroutine
                     </code></pre>
          </section>
          <section>
            <h2>Addressing modes</h2>
            <pre><code class="asm6502" data-trim>
a9 20     LDA #$20     ; A = 0x20

a5 70     LDA $70      ; A = readmem(0x70)

ad 34 12  LDA $1234    ; A = readmem(0x1234)
                     </code></pre>
          </section>
          <section>
            <h2>Addressing modes</h2>
            <pre><code class="asm6502" data-trim>
bd 34 12  LDA $1234, X ; A = readmem(0x1234 + X)
b9 34 12  LDA $1234, Y ; A = readmem(0x1234 + Y)

b1 70     LDA ($70), Y ; t1 = readmem(0x70)
                       ; t2 = readmem(0x71)
                       ; addr = t1 | (t2&lt;&lt;8)
                       ; A = readmem(addr + Y)

b5 70     LDA $70, X   ; A = readmem(0x70 + X)
                     </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Emulating a 6502</h2>
            <ul class="fragment">
              <li>Fetch next instruction</li>
              <li>Decode it</li>
              <li>Execute it</li>
            </ul>
          </section>
          <section>
            <h2>Emulation</h2>
            <pre><code class="javascript" data-trim data-noescape>
<span class="fragment highlight-current-code">var a = 0, x = 0, y = 0, pc = readword(0xfffe);
</span>while (true) {
  switch (<span class="fragment highlight-current-code">readmem(pc++)</span>) {
<div class="fragment highlight-current-code">  case 0xa9: // LDA #imm
    a = readmem(pc++); break;
</div><div class="fragment highlight-current-code">  case 0xad: // LDA $addr
    var addr = readword(pc); pc += 2;
    a = readmem(addr);
    break;
</div>  // and so on for all other instructions...
  }
}
</code></pre>
          </section>
          <section>
            <h2>Except...</h2>
            <ul>
              <li>Setting flags</li>
              <li>Memory access</li>
              <li>Hardware</li>
              <li>Interrupts</li>
              <li>Handling time</li>
            </ul>
          </section>
          <section>
            <h2>Processor status: Flags</h2>
            <table class="horizontal">
              <thead>
                <tr>
                  <th>7</th>
                  <th>6</th>
                  <th>5</th>
                  <th>4</th>
                  <th>3</th>
                  <th>2</th>
                  <th>1</th>
                  <th>0</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Negative</td>
                  <td>oVerflow</td>
                  <td>-</td>
                  <td>-</td>
                  <td>Decimal</td>
                  <td>Interrupt<br />disable</td>
                  <td>Zero</td>
                  <td>Carry</td>
                </tr>
              </tbody>
            </table>
            <br />
            <ul class="fragment">
              <li>Z &amp; N set on ALU/load instruction</li>
              <li>C set by shifts &amp; arithmetic</li>
              <li>V set by arithmetic</li>
              <li>D, V, C and I controlled by special instructions</li>
            </ul>
          </section>
          <section>
            <h2>So now we have:</h2>
            <pre><code class="javascript" data-trim>
case 0xa9: // LDA #imm
  a = readmem(pc++);
  p.z = !a;
  p.n = !!(a &amp; 0x80);
  break;             </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Memory</h2>
            <table class="memmap">
              <tbody>
                <tr>
                  <th style="width: 30%">0x10000</th>
                  <td></td>
                </tr>
                <tr class="osrom">
                  <th>0xff00</th>
                  <td>256 bytes OS ROM</td>
                </tr>
                <tr class="hw">
                  <th>0xfe00</th>
                  <td>256 bytes hardware</td>
                </tr>
                <tr class="osrom">
                  <th>0xfd00</th>
                  <td>256 bytes ROM</td>
                </tr>
                <tr class="hw">
                  <th>0xfc00</th>
                  <td>256 bytes hardware</td>
                </tr>
                <tr class="osrom">
                  <th>&uarr;<br />&uarr;<br />&uarr;<br />0xc000</th>
                  <td>15.5KB OS ROM</td>
                </tr>
                <tr class="rom1">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x8000
                  </th>
                  <td>16KB Paged ROM</td>
                </tr>
                <tr class="ram2">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x4000
                  </th>
                  <td>16KB RAM</td>
                </tr>
                <tr class="ram1">
                  <th>
                    &uarr;<br />&uarr;<br />&uarr;<br />&uarr;<br />0x0000
                  </th>
                  <td>16KB RAM</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <pre><code class="javascript" data-trim>
var ram = new Uint8Array(0x8000), romsel = 0, roms = [];
var os = load("OS");
roms[15] = load("BASIC");

function readmem(addr) {
  if (addr &lt; 0x8000) return ram[addr];
  if (addr &lt; 0xc000) return roms[romsel][addr - 0x8000];
  if ((addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00)
      || (addr &gt;= 0xfc00 &amp;&amp; addr &lt; 0xfd00))
    return readhw(addr);
  return os[addr - 0xc000];
}
                         </code></pre>
          </section>
          <section>
            <pre><code class="javascript" data-trim>
function writemem(addr, b) {
    if (addr &lt; 0x8000) ram[addr] = b;
    if (addr &gt;= 0xfe00 &amp;&amp; addr &lt; 0xff00) writehw(addr, b);
    // else does nothing - it's ROM
}
                         </code></pre>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>The outside world</h2>
            <ul>
              <li class="fragment">
                Video chip:
                <ul>
                  <li>Pixel generator reads from RAM</li>
                  <li>Simple character-mapped mode</li>
                  <li>Bitmap modes with 2, 4, 16 colours</li>
                </ul>
              </li>
              <li class="fragment">Sound (SN76489)</li>
              <li class="fragment">Timers (6522 VIA)</li>
            </ul>
          </section>
          <section>
            <h2>
              <a
                href="https://bbc.xania.org/?videoCyclesBatch=8000&disc=Welcome.ssd&keyLayout=physical"
                >Demo</a
              >
            </h2>
            <aside class="notes">
              <ul>
                <li>Show MODE 7, another video mode.</li>
                <li>Show "hello world"</li>
                <li>Load up welcome, run kingdom?</li>
                <li>Run Elite...oh noes</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>What happened?</h2>
            <img src="BrokenElite.png" class="stretch" />
          </section>
          <section>
            <h2>Fixing it</h2>
            <pre><code class="javascript" data-trim data-noescape>
case 0xa9: // LDA #imm
<div class="fragment highlight-current-code">  a = readmem(pc++);
  p.z = !a;
  p.n = !!(a &amp; 0x80);
</div><div class="fragment highlight-current-code">  video.run(2);
</div><div class="fragment highlight-current-code">  timers.run(2);
</div>  break;
                     </code></pre>

            <h3 class="fragment">
              <a
                href="https://bbc.xania.org/?disc=elite.ssd&autoboot&keyLayout=physical"
                >Demo</a
              >
            </h3>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>More games</h2>
            <img src="Zalaga.png" class="stretch" />
            <h3>
              <a
                href="https://bbc.xania.org/?disc=Zalaga.ssd&autoboot&keyLayout=gaming&model=Master"
                >Zalaga</a
              >
            </h3>
            <aside class="notes">
              Fun part of emulation! e.g. address $1114. SAX zp instruction.
              show debugger
            </aside>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <ul>
              <table class="opcodes">
                <tr>
                  <th>
                    $84 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >00</span
                    >
                  </th>
                  <td>STY zp</td>
                </tr>
                <tr>
                  <th>
                    $85 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >01</span
                    >
                  </th>
                  <td>STA zp</td>
                </tr>
                <tr>
                  <th>
                    $86 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >10</span
                    >
                  </th>
                  <td>STX zp</td>
                </tr>
                <tr>
                  <th>
                    $87 100001<span
                      class="fragment highlight-current-red"
                      data-fragment-index="1"
                      >11</span
                    >
                  </th>
                  <td>???</td>
                </tr>
              </table>
            </ul>
          </section>
          <section>
            <h2>Real decoding</h2>
            <img src="6502_pad_annot_07.png" class="stretch" />
            <div class="credit">
              &copy;2010 Visual6502.org, used with permission
            </div>
            <aside class="notes">
              Thanks to Visual 6502 people!<br />
              PLA is a 130x21 ROM, indexed by 8 instr bits + ~bits (minus one),
              and 6 bits of T-state.. output is 130 bits that enable various
              parts of the chip. SAX enables both "A" and "X" parts NMOS
              transistors drain? something?
            </aside>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <pre style="width: 40%">
                 <span class="fragment highlight-current-red" data-fragment-index="2">+-----+</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">-----</span><span
                         class="fragment highlight-current-red" data-fragment-index="1">+-----+</span>
                 <span class="fragment highlight-current-red" data-fragment-index="2">|  A  |</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">  X  </span><span
                         class="fragment highlight-current-red" data-fragment-index="1">|  Y  |</span>
                 <span class="fragment highlight-current-red" data-fragment-index="2">+-----+</span><span
                         class="fragment highlight-current-red" data-fragment-index="3">-----</span><span
                         class="fragment highlight-current-red" data-fragment-index="1">+-----+</span>
                    <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
        /+--------- <span class="fragment highlight-current-red" data-fragment-index="2">|</span> --- <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span> <span
                         class="fragment highlight-current-red" data-fragment-index="1">(!s && !t)</span>
        ||          <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
+----------+        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
| opcode|| |        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
| 100001<span class="fragment highlight-current-red" data-fragment-index="3">s</span><span
                         class="fragment highlight-current-red" data-fragment-index="2">t</span> |<span
                         class="fragment highlight-current-red"
                         data-fragment-index="2">------->t</span>     <span class="fragment highlight-current-red"
                                                                            data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
+----------+        <span class="fragment highlight-current-red" data-fragment-index="2">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
     ^  <span class="fragment highlight-current-red" data-fragment-index="3">\----------</span> <span
                         class="fragment highlight-current-red" data-fragment-index="2">|</span> <span
                         class="fragment highlight-current-red" data-fragment-index="3">--->s</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span>
     |              <span class="fragment highlight-current-red" data-fragment-index="2">\</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>     <span
                         class="fragment highlight-current-red" data-fragment-index="1">/</span>
     |               <span class="fragment highlight-current-red" data-fragment-index="2">\</span>    <span
                         class="fragment highlight-current-red" data-fragment-index="3">|</span>    <span
                         class="fragment highlight-current-red" data-fragment-index="1">/</span>
  select              write bus
   store
            </pre>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <pre style="width: 40%">
                 <span class="fragment highlight-current-red" data-fragment-index="1">+-----+-----+</span>-----+
                 <span class="fragment highlight-current-red" data-fragment-index="1">|  A  |  X  |</span>  Y  |
                 <span class="fragment highlight-current-red" data-fragment-index="1">+-----+-----+</span>-----+
                    <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
        /+--------- <span class="fragment highlight-current-red" data-fragment-index="1">|</span> --- <span
                         class="fragment highlight-current-red" data-fragment-index="1">|</span> (!s && !t)
        ||          <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
+----------+        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
| opcode|| |        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
| 100001<span class="fragment highlight-current-red" data-fragment-index="1">st</span> |<span
                         class="fragment highlight-current-red" data-fragment-index="1">------->t     |</span>     |
+----------+        <span class="fragment highlight-current-red" data-fragment-index="1">|     |</span>     |
     ^  <span class="fragment highlight-current-red" data-fragment-index="1">\---------- | --->s</span>     |
     |              <span class="fragment highlight-current-red" data-fragment-index="1">\     |</span>     /
     |               <span class="fragment highlight-current-red" data-fragment-index="1">\    |</span>    /
  select              write bus
   store
            </pre>
          </section>
          <section>
            <h2>Inside the 6502</h2>
            <table class="opcodes">
              <tr>
                <th>$84 10000100</th>
                <td>STY zp</td>
              </tr>
              <tr>
                <th>$85 10000101</th>
                <td>STA zp</td>
              </tr>
              <tr>
                <th>$86 10000110</th>
                <td>STX zp</td>
              </tr>
              <tr>
                <th>$87 10000111</th>
                <td><b>SAX zp</b></td>
              </tr>
            </table>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Even more games</h2>
            <img src="Alien8.png" class="stretch" />
            <h4>An admission</h4>
          </section>
          <section>
            <h2>Protection systems</h2>
            <ul>
              <li>Decrypt game code</li>
              <li>
                Keys include:
                <ul>
                  <li>Magic values loaded from tape (or disc)</li>
                  <li class="fragment">Decryption code itself</li>
                  <li class="fragment">Hardware timers &amp; registers</li>
                  <li class="fragment">Interrupt information</li>
                  <li class="fragment">Read-modify-write</li>
                </ul>
              </li>
            </ul>
            <aside class="notes">
              Disc images mostly hacked Doing tape support -> oh noes
            </aside>
          </section>
          <section>
            <h2>Accurate timing information</h2>
            <h3>
              <a href="http://visual6502.org/JSSim/expert.html?a=0&d=2e48fe"
                >Visual 6502</a
              >
            </h3>
          </section>
          <section>
            <h2>ROL $fe48</h2>
            <table class="rol">
              <tr>
                <th>Cycle</th>
                <th>Read / Write</th>
                <th>Address</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>0</td>
                <td>Read</td>
                <td>0d2d</td>
                <td>Read opcode (2e)</td>
              </tr>
              <tr>
                <td>1</td>
                <td>Read</td>
                <td>0d2e</td>
                <td>Read low byte of address (48)</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Read</td>
                <td>0d2f</td>
                <td>Read high byte of address (fe)</td>
              </tr>
              <tr>
                <td>3</td>
                <td>Read</td>
                <td>fe48</td>
                <td>Read memory at $fe48</td>
              </tr>
              <tr>
                <td>4</td>
                <td>Write</td>
                <td>fe48</td>
                <td>
                  Do rotate
                  <span class="fragment" style="color: #ff2c2d"
                    >&mdash; writes unmodified value!</span
                  >
                </td>
              </tr>
              <tr>
                <td>5</td>
                <td>Write</td>
                <td>fe48</td>
                <td>Store to $fe48</td>
              </tr>
            </table>
          </section>
          <section>
            <h2>Fixing it</h2>
            <pre><code class="javascript" data-trim data-noescape>
case 0x2e: // ROL abs
<div class="fragment highlight-current-code">  addr = readword(pc); pc += 2;
  hardware.run(3);
</div><div class="fragment highlight-current-code">  val = readbyte(addr);
  hardware.run(1);
</div><div class="fragment highlight-current-code">  writebyte(addr, val); // unmodified value
  hardware.run(1);
</div><div class="fragment highlight-current-code">  val = (val &lt;&lt; 1) | (carry ? 1);
  carry = val & 0x100;
</div><div class="fragment highlight-current-code">  writebyte(addr, val & 0xff); // modified value
  hardware.run(1);
</div>  break;
                     </code></pre>
          </section>
          <section>
            <h2>Cycle stretching</h2>
            <div class="wavedrom">
              <script type="WaveDrom">
                { signal : [
                  { name: "CPU @ 2 MHz",  wave: "N......." },
                  { name: "H/W @ 1 MHz",  wave: "N...", period: 2 },
                  {                 node: "..A.B...", phase: 0.5 },
                  { name: "Case 1", wave: "N.h.N..." },
                  {                 node: "...CD...", phase: 0.5 },
                  { name: "Case 2", wave: "N..hN..." }
                ],
                edge: ['A-&gt;B stretch', 'C-&gt;D stretch']
                }
              </script>
            </div>
          </section>
        </section>

        <!---------------------------------------------------------------------->
        <section>
          <section>
            <h2>Conclusion</h2>
            <img class="stretch" src="tt26.jpg" />
          </section>
          <section>
            <h2>Resources</h2>
            <ul>
              <li>
                <a href="https://bbc.xania.org/">https://bbc.xania.org/</a>
              </li>
              <li>
                Source on
                <a href="https://github.com/mattgodbolt/jsbeeb"
                  >github.com/mattgodbolt/jsbeeb</a
                >
              </li>
              <li>
                <a href="http://visual6502.org">http://visual6502.org/</a>
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/EvilIn11.ssd&autoboot&model=Master"
                  >Bitshifters' latest demo</a
                >
              </li>
            </ul>
          </section>
          <section>
            <h2>Some Demos</h2>
            <ul>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/bs-scr-beeb.ssd&autoboot&model=Master"
                >
                  Stunt Car Racer
                </a>
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/crtc-somenastyeffects.ssd&autoboot&model=Master"
                  >Some Nasty Effects</a
                >
              </li>
              <li>
                <a
                  href="https://bbc.xania.org/?disc=https://bitshifters.github.io/content/TheMaster-Demo128.ssd&autoboot&model=Master"
                  >The Master</a
                >
              </li>
              <!--<li><a href="http://localhost/jsbeeb/?disc=Blurp.ssd&autoboot&keyLayout=physical">Blurp</a></li>-->
              <li><a href="https://bitshifters.github.io/">Bitshifters</a></li>
            </ul>
          </section>
        </section>
      </section>
      <div class="footer">
        <div class="footer-img"><img src="ce.svg"/></div>
        <div>
          &copy; 2025 Matt Godbolt - CppCon 2025
          <a
            href="https://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1"
            >CC BY-NC 4.0</a
          >
        </div>
      </div>
    </div>

    <script type="module">
      import Reveal from "./reveal.js/dist/reveal.esm.js";
      import Highlight from "./reveal.js/plugin/highlight/highlight.esm.js";

      // Register custom 6502 assembly language for syntax highlighting
      import('./reveal.js/plugin/highlight/highlight.esm.js').then((hljs) => {
        function asm6502() {
          return {
            k: {
              keyword:
                "LDA LDX LDY STA STX STY INC INX INY DEC DEX DEY CMP CPX CPY BEQ BNE BMI BPL BCS BCC BVS BVC " +
                "JMP JSR RTS RTI ASL ROL ROR PHP PHA PHX PHY PLP PLA PLX PLY TAX TAY TXA TYA TXS TSX ADC SBC " +
                "SEC CLC SED CLD SEI CLI",
              built_in: "A X Y",
            },
            c: [
              { cN: "comment", b: ";", e: "$" },
              { cN: "labeldef", b: "^\\.[a-zA-Z_][a-zA-Z_0-9]*" },
              { cN: "opcodes", b: "^[0-9a-f]{2}( [0-9a-f]{2})*" },
              { cN: "label", b: "[a-z][a-zA-Z]*" },
              { cN: "literal", b: "#?\\$?[0-9a-f]+" },
            ],
          };
        }
        
        if (window.hljs) {
          hljs.registerLanguage("asm6502", asm6502);
        }
      });

      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        slideNumber: true,
        width: 1920,
        height: 800,
        transition: "fade",
        plugins: [Highlight],
      });

      // Load WaveDrom if it exists
      if (typeof WaveDrom !== 'undefined') {
        WaveDrom.ProcessAll();
      }

      // Load fullscreen-img functionality
      import('./lib/js/fullscreen-img.js').catch(() => {});
      
      // Import and initialize blink.js functionality
      import('./blink.js').then(module => {
        if (module.initializeBlink) {
          module.initializeBlink();
        }
      }).catch(() => {});
    </script>
  </body>
</html>
